<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P&S Music Player With Lyrics</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== å…¨å±€æ ·å¼ ==================== */
        :root {
            --color-pink: #ff87ab;
            --color-stocking: #c39dff;
            --bg-glass: rgba(255, 255, 255, 0.75);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(160deg, #ffea7f 0%, #ff87ab 45%, #c39dff 100%);
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        /* æ’­æ”¾å™¨å¡ç‰‡ */
        .player-card {
            width: 100%; max-width: 380px; height: 600px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 30px; padding: 30px 25px;
            box-shadow: var(--shadow);
            display: flex; flex-direction: column; align-items: center;
            position: relative; transition: all 0.3s ease;
        }

        /* é¡¶éƒ¨æ˜¾ç¤ºåŒº (å”±ç‰‡/æ­Œè¯åˆ‡æ¢) */
        .visual-area {
            width: 100%; flex: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 20px; overflow: hidden;
        }

        /* å”±ç‰‡æ¨¡å¼ */
        .disc-wrapper {
            width: 220px; height: 220px;
            border-radius: 50%; border: 5px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            position: absolute; transition: opacity 0.4s, transform 0.4s;
            background: linear-gradient(135deg, #ffea7f, #ff87ab);
            cursor: pointer;
        }
        .music-disc {
            width: 100%; height: 100%; border-radius: 50%;
            background-size: cover; background-position: center;
        }
        .rotate { animation: spin 10s linear infinite; }
        .paused { animation-play-state: paused; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* æ­Œè¯æ¨¡å¼ */
        .lyric-wrapper {
            width: 100%; height: 100%;
            position: absolute;
            opacity: 0; pointer-events: none; transform: scale(0.9);
            transition: opacity 0.4s, transform 0.4s;
            text-align: center;
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            cursor: pointer;
        }
        
        .lyric-list {
            list-style: none; padding: 140px 0; margin: 0;
            transition: transform 0.3s ease-out;
        }
        .lyric-line {
            color: #666; font-size: 0.9rem; line-height: 1.8;
            padding: 6px 10px; transition: all 0.3s;
            min-height: 30px;
        }
        .lyric-line.active {
            color: var(--color-pink); font-size: 1.1rem; font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 135, 171, 0.4);
            transform: scale(1.05);
        }
        /* åŒè¯­æ­Œè¯çš„ç¬¬äºŒè¡Œ */
        .lyric-line span { display: block; font-size: 0.8em; opacity: 0.8; font-weight: normal; }

        /* åˆ‡æ¢çŠ¶æ€ç±» */
        .show-lyrics .disc-wrapper { opacity: 0; pointer-events: none; transform: scale(0.8); }
        .show-lyrics .lyric-wrapper { opacity: 1; pointer-events: auto; transform: scale(1); }

        /* æ­Œæ›²ä¿¡æ¯ */
        .song-info { text-align: center; width: 100%; margin-bottom: 15px; z-index: 2; }
        .song-title { font-size: 1.3rem; font-weight: 700; color: #333; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-status { font-size: 0.8rem; color: #666; font-weight: 500; }

        /* è¿›åº¦æ¡ */
        .progress-area {
            width: 100%; display: flex; align-items: center; gap: 10px;
            font-size: 0.7rem; color: #555; font-weight: 600; margin-bottom: 20px; z-index: 2;
        }
        .progress-bar {
            flex: 1; -webkit-appearance: none; height: 5px;
            background: rgba(0,0,0,0.1); border-radius: 3px; outline: none; cursor: pointer;
        }
        .progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%;
            background: var(--color-pink); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .controls { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; margin-bottom: 10px; z-index: 2; }
        .btn { background: none; border: none; cursor: pointer; color: #555; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-mode { font-size: 1.2rem; width: 40px; height: 40px; }
        .btn-prev, .btn-next { font-size: 1.8rem; width: 50px; height: 50px; }
        .btn-play {
            width: 60px; height: 60px; background: linear-gradient(135deg, var(--color-pink), var(--color-stocking));
            border-radius: 50%; color: white; font-size: 1.6rem; box-shadow: 0 8px 20px rgba(255, 135, 171, 0.4);
        }
        .btn:hover { transform: scale(1.1); color: var(--color-pink); }
        .btn-play:hover { transform: scale(1.05) translateY(-2px); color: white; }
        .mode-loop { color: var(--color-pink) !important; text-shadow: 0 0 5px rgba(255,135,171,0.5); }
        .mode-random { color: var(--color-stocking) !important; text-shadow: 0 0 5px rgba(195,157,255,0.5); }

        /* æ­Œå•åˆ—è¡¨ (è¦†ç›–å±‚) */
        .playlist-box {
            position: absolute; bottom: 0; left: 0; width: 100%; max-height: 0;
            background: rgba(255,255,255,0.95); border-radius: 25px;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; z-index: 10;
        }
        .playlist-box.show { max-height: 60%; border-top: 1px solid rgba(0,0,0,0.1); box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .playlist-item { padding: 12px 20px; font-size: 0.9rem; color: #444; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
        .playlist-item:hover { background: rgba(255, 135, 171, 0.1); }
        .playlist-item.active { color: var(--color-pink); font-weight: 700; }
        .playlist-item.active::before { content: 'â™ª '; }
    </style>
</head>
<body>

    <div class="player-card" id="playerCard">
        <!-- è§†è§‰åŒºï¼šå”±ç‰‡/æ­Œè¯ -->
        <div class="visual-area">
            <!-- å”±ç‰‡ -->
            <div class="disc-wrapper" id="discWrapper" title="ç‚¹å‡»æŸ¥çœ‹æ­Œè¯">
                <div class="music-disc" id="disc"></div>
            </div>
            <!-- æ­Œè¯ -->
            <div class="lyric-wrapper" id="lyricWrapper" title="ç‚¹å‡»è¿”å›å°é¢">
                <ul class="lyric-list" id="lyricList">
                    <li class="lyric-line">P&S Radio Station</li>
                </ul>
            </div>
        </div>

        <!-- ä¿¡æ¯ -->
        <div class="song-info">
            <div class="song-title" id="songTitle">Loading...</div>
            <div class="song-status" id="songStatus">Tap disc for lyrics</div>
        </div>

        <!-- è¿›åº¦ -->
        <div class="progress-area">
            <span id="currTime">0:00</span>
            <input type="range" class="progress-bar" id="progressBar" value="0" min="0" max="100">
            <span id="totalTime">0:00</span>
        </div>

        <!-- æ§åˆ¶ -->
        <div class="controls">
            <button class="btn btn-mode" id="modeBtn">ğŸ”</button>
            <button class="btn btn-prev" id="prevBtn">â®</button>
            <button class="btn btn-play" id="playBtn">â–¶</button>
            <button class="btn btn-next" id="nextBtn">â­</button>
            <button class="btn btn-mode" id="listBtn">ğŸ“œ</button>
        </div>

        <!-- æ­Œå• -->
        <div class="playlist-box" id="playlistBox"></div>
    </div>

    <audio id="bgmAudio" preload="none"></audio>

    <script>
        class MusicPlayer {
            constructor() {
                this.baseUrl = "https://stockielchan.github.io/stocking-music/";
                this.jsonUrl = this.baseUrl + "music.json?t=" + new Date().getTime();
                this.defaultCover = this.baseUrl + "musicmenu.jpg";

                this.audio = document.getElementById('bgmAudio');
                this.disc = document.getElementById('disc');
                this.titleEl = document.getElementById('songTitle');
                this.statusEl = document.getElementById('songStatus');
                this.progressBar = document.getElementById('progressBar');
                this.currTimeEl = document.getElementById('currTime');
                this.totalTimeEl = document.getElementById('totalTime');
                this.playlistBox = document.getElementById('playlistBox');
                this.lyricList = document.getElementById('lyricList');
                this.playerCard = document.getElementById('playerCard');

                this.playBtn = document.getElementById('playBtn');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.modeBtn = document.getElementById('modeBtn');
                this.listBtn = document.getElementById('listBtn');

                this.playlist = [];
                this.currentIndex = 0;
                this.isPlaying = false;
                this.isDragging = false;
                this.lyrics = []; // å­˜å‚¨è§£æåçš„æ­Œè¯å¯¹è±¡æ•°ç»„
                this.hasLyrics = false;

                this.playMode = 0; 
                this.modes = [
                    { icon: 'ğŸ”', name: 'é¡ºåº', class: '' },
                    { icon: 'ğŸ”‚', name: 'å•æ›²', class: 'mode-loop' },
                    { icon: 'ğŸ”€', name: 'éšæœº', class: 'mode-random' }
                ];

                this.init();
            }

            async init() {
                this.bindEvents();
                await this.fetchMusic();
                this.updateCover(null);
            }

            async fetchMusic() {
                try {
                    const res = await fetch(this.jsonUrl);
                    if (!res.ok) throw new Error("Config Error");
                    const data = await res.json();
                    this.playlist = data.map(item => ({
                        title: item.title,
                        url: this.baseUrl + encodeURIComponent(item.file),
                        cover: item.cover ? this.baseUrl + encodeURIComponent(item.cover) : null,
                        lrc: item.lrc ? this.baseUrl + encodeURIComponent(item.lrc) : null
                    }));
                    if (this.playlist.length > 0) {
                        this.renderPlaylist();
                        this.loadSong(0, false);
                    } else {
                        this.titleEl.textContent = "æ­Œå•ä¸ºç©º";
                    }
                } catch (e) {
                    console.error(e);
                    this.titleEl.textContent = "åŠ è½½å¤±è´¥";
                }
            }

            renderPlaylist() {
                this.playlistBox.innerHTML = '';
                this.playlist.forEach((song, i) => {
                    const div = document.createElement('div');
                    div.className = 'playlist-item';
                    div.textContent = `${i + 1}. ${song.title}`;
                    div.onclick = () => {
                        this.loadSong(i, true);
                        this.toggleList(); // é€‰æ­Œåè‡ªåŠ¨æ”¶èµ·åˆ—è¡¨
                    };
                    this.playlistBox.appendChild(div);
                });
            }

            loadSong(index, autoPlay = true) {
                if (!this.playlist[index]) return;
                this.currentIndex = index;
                const song = this.playlist[index];

                this.audio.src = song.url;
                this.titleEl.textContent = song.title;
                this.updateCover(song.cover);
                this.highlightPlaylist(index);
                
                // åŠ è½½æ­Œè¯
                this.loadLyrics(song.lrc);

                this.progressBar.value = 0;
                this.updateProgressBg(0);
                this.currTimeEl.textContent = "0:00";

                if (autoPlay) this.play();
            }

            // --- ğŸµ æ­Œè¯æ ¸å¿ƒé€»è¾‘ ---
            async loadLyrics(lrcUrl) {
                this.lyricList.innerHTML = '<li class="lyric-line">Loading lyrics...</li>';
                this.lyrics = [];
                this.hasLyrics = false;

                if (!lrcUrl) {
                    this.lyricList.innerHTML = '<li class="lyric-line">æš‚æ— æ­Œè¯ / Pure Music</li>';
                    return;
                }

                try {
                    const res = await fetch(lrcUrl);
                    if (res.ok) {
                        const text = await res.text();
                        this.parseLyrics(text);
                        this.renderLyrics();
                        this.hasLyrics = true;
                    } else {
                        throw new Error("LRC 404");
                    }
                } catch (e) {
                    this.lyricList.innerHTML = '<li class="lyric-line">æ­Œè¯åŠ è½½å¤±è´¥</li>';
                }
            }

            parseLyrics(text) {
                const lines = text.split('\n');
                const regex = /^\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)$/;
                let tempLyrics = [];

                lines.forEach(line => {
                    const matches = line.trim().match(regex);
                    if (matches) {
                        const min = parseInt(matches[1]);
                        const sec = parseInt(matches[2]);
                        const ms = parseInt(matches[3]);
                        const time = min * 60 + sec + ms / 1000;
                        const content = matches[4].trim();
                        if (content) {
                            tempLyrics.push({ time, content });
                        }
                    }
                });

                // åŒè¯­åˆå¹¶ä¼˜åŒ–ï¼šå¦‚æœä¸¤ä¸ªæ—¶é—´æˆ³æå…¶æ¥è¿‘ï¼ˆ<0.1sï¼‰ï¼Œè§†ä¸ºåŒä¸€å¥çš„åŒè¯­ç¿»è¯‘
                this.lyrics = [];
                for (let i = 0; i < tempLyrics.length; i++) {
                    const curr = tempLyrics[i];
                    const next = tempLyrics[i + 1];

                    // å¦‚æœä¸‹ä¸€å¥æ—¶é—´å’Œè¿™ä¸€å¥ä¸€æ ·ï¼Œåˆå¹¶
                    if (next && Math.abs(next.time - curr.time) < 0.2) {
                        this.lyrics.push({
                            time: curr.time,
                            content: curr.content + `<span>${next.content}</span>` // ç”¨ span åŒ…è£¹ç¿»è¯‘
                        });
                        i++; // è·³è¿‡ä¸‹ä¸€å¥
                    } else {
                        this.lyrics.push(curr);
                    }
                }
            }

            renderLyrics() {
                this.lyricList.innerHTML = '';
                // åŠ ä¸Šç©ºçš„å ä½è¡Œï¼Œä¸ºäº†è®©ç¬¬ä¸€å¥èƒ½å±…ä¸­
                this.lyricList.innerHTML += '<li class="lyric-line" style="height: 100px;"></li>';
                
                this.lyrics.forEach((line, i) => {
                    const li = document.createElement('li');
                    li.className = 'lyric-line';
                    li.innerHTML = line.content; // å…è®¸ HTML (<span>)
                    li.dataset.index = i;
                    this.lyricList.appendChild(li);
                });
                
                this.lyricList.innerHTML += '<li class="lyric-line" style="height: 120px;"></li>';
            }

            syncLyrics(currentTime) {
                if (!this.hasLyrics) return;

                let activeIndex = -1;
                for (let i = 0; i < this.lyrics.length; i++) {
                    if (currentTime >= this.lyrics[i].time) {
                        activeIndex = i;
                    } else {
                        break;
                    }
                }

                if (activeIndex !== -1) {
                    const activeLine = this.lyricList.querySelectorAll('.lyric-line[data-index]')[activeIndex];
                    if (activeLine && !activeLine.classList.contains('active')) {
                        // ç§»é™¤æ—§é«˜äº®
                        const oldActive = this.lyricList.querySelector('.active');
                        if (oldActive) oldActive.classList.remove('active');
                        
                        // æ·»åŠ æ–°é«˜äº®
                        activeLine.classList.add('active');
                        
                        // æ»šåŠ¨é€»è¾‘
                        const containerHeight = document.getElementById('lyricWrapper').clientHeight;
                        const offset = activeLine.offsetTop - containerHeight / 2 + activeLine.clientHeight / 2;
                        this.lyricList.style.transform = `translateY(-${Math.max(0, offset)}px)`;
                    }
                }
            }
            // -------------------------

            updateCover(url) {
                const imgUrl = url || this.defaultCover;
                this.disc.style.backgroundImage = `url('${imgUrl}')`;
            }

            highlightPlaylist(index) {
                const items = this.playlistBox.querySelectorAll('.playlist-item');
                items.forEach(el => el.classList.remove('active'));
                if (items[index]) {
                    items[index].classList.add('active');
                    items[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            play() {
                this.audio.play().then(() => {
                    this.isPlaying = true;
                    this.updatePlayBtn();
                    this.disc.classList.remove('paused');
                    this.disc.classList.add('rotate');
                }).catch(() => {});
            }

            pause() {
                this.audio.pause();
                this.isPlaying = false;
                this.updatePlayBtn();
                this.disc.classList.add('paused');
            }

            togglePlay() { this.isPlaying ? this.pause() : this.play(); }
            updatePlayBtn() { this.playBtn.textContent = this.isPlaying ? 'â¸' : 'â–¶'; }

            next(isAuto = false) {
                if (isAuto && this.playMode === 1) {
                    this.audio.currentTime = 0; this.play(); return;
                }
                let nextIdx;
                if (this.playMode === 2) {
                    do { nextIdx = Math.floor(Math.random() * this.playlist.length); }
                    while (this.playlist.length > 1 && nextIdx === this.currentIndex);
                } else {
                    nextIdx = (this.currentIndex + 1) % this.playlist.length;
                }
                this.loadSong(nextIdx, true);
            }

            prev() {
                let prevIdx = (this.currentIndex - 1 + this.playlist.length) % this.playlist.length;
                this.loadSong(prevIdx, true);
            }

            toggleMode() {
                this.playMode = (this.playMode + 1) % 3;
                const mode = this.modes[this.playMode];
                this.modeBtn.textContent = mode.icon;
                this.modeBtn.className = 'btn btn-mode ' + mode.class;
                const oldStatus = this.statusEl.textContent;
                this.statusEl.textContent = `Mode: ${mode.name}`;
                setTimeout(() => { if(this.statusEl.textContent.includes('Mode')) this.statusEl.textContent = oldStatus; }, 1500);
            }

            toggleList() { this.playlistBox.classList.toggle('show'); }
            
            // åˆ‡æ¢æ­Œè¯/å°é¢æ˜¾ç¤º
            toggleVisual() {
                this.playerCard.classList.toggle('show-lyrics');
            }

            formatTime(s) {
                if (isNaN(s)) return "0:00";
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m}:${sec < 10 ? '0' + sec : sec}`;
            }

            updateProgressBg(percent) {
                this.progressBar.style.background = `linear-gradient(to right, var(--color-pink) ${percent}%, rgba(0,0,0,0.05) ${percent}%)`;
            }

            bindEvents() {
                this.playBtn.onclick = () => this.togglePlay();
                this.nextBtn.onclick = () => this.next();
                this.prevBtn.onclick = () => this.prev();
                this.modeBtn.onclick = () => this.toggleMode();
                this.listBtn.onclick = () => this.toggleList();
                
                // è§†è§‰åŒºç‚¹å‡»åˆ‡æ¢
                document.getElementById('discWrapper').onclick = () => this.toggleVisual();
                document.getElementById('lyricWrapper').onclick = () => this.toggleVisual();

                this.audio.onended = () => this.next(true);
                this.audio.onloadedmetadata = () => {
                    this.totalTimeEl.textContent = this.formatTime(this.audio.duration);
                };

                this.audio.ontimeupdate = () => {
                    if (this.isDragging) return;
                    const curr = this.audio.currentTime;
                    const total = this.audio.duration;
                    
                    // åŒæ­¥æ­Œè¯
                    this.syncLyrics(curr);

                    if (total) {
                        const percent = (curr / total) * 100;
                        this.progressBar.value = percent;
                        this.updateProgressBg(percent);
                        this.currTimeEl.textContent = this.formatTime(curr);
                    }
                };

                this.progressBar.oninput = (e) => {
                    this.isDragging = true;
                    const percent = e.target.value;
                    this.updateProgressBg(percent);
                    this.currTimeEl.textContent = this.formatTime((percent / 100) * this.audio.duration);
                };

                this.progressBar.onchange = (e) => {
                    this.isDragging = false;
                    this.audio.currentTime = (e.target.value / 100) * this.audio.duration;
                    if (!this.isPlaying) this.play();
                };
            }
        }

        new MusicPlayer();
    </script>
</body>
</html>