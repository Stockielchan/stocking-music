<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P&S Music Player</title>
    
    <!-- å¼•å…¥å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== å…¨å±€æ ·å¼ ==================== */
        :root {
            --color-pink: #ff87ab;
            --color-stocking: #c39dff;
            --color-cyan: #00e5ff;
            --bg-glass: rgba(255, 255, 255, 0.75);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            /* P&S æ ‡å¿—æ€§æ¸å˜èƒŒæ™¯ */
            background: linear-gradient(160deg, #ffea7f 0%, #ff87ab 45%, #c39dff 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* é˜²æ­¢å‡ºç°æ»šåŠ¨æ¡ */
        }

        /* ==================== æ’­æ”¾å™¨å¡ç‰‡ ==================== */
        .player-card {
            width: 100%;
            max-width: 380px; /* å¡ç‰‡æœ€å¤§å®½åº¦ */
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 30px;
            padding: 30px 25px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: all 0.3s ease;
        }

        /* å”±ç‰‡åŒºåŸŸ */
        .disc-wrapper {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 5px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #ffea7f, #ff87ab);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .music-disc {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            border-radius: 50%;
        }
        
        /* æ—‹è½¬åŠ¨ç”» */
        .rotate { animation: spin 10s linear infinite; }
        .paused { animation-play-state: paused; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* æ­Œæ›²ä¿¡æ¯ */
        .song-info {
            text-align: center;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .song-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-status {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        /* è¿›åº¦æ¡ */
        .progress-area {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.75rem;
            color: #555;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .progress-bar {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: rgba(0,0,0,0.05);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        .progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--color-pink);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .progress-bar::-webkit-slider-thumb:active { transform: scale(1.3); }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            margin-bottom: 20px;
        }

        .btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #555;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-mode { font-size: 1.2rem; width: 40px; height: 40px; }
        .btn-prev, .btn-next { font-size: 1.8rem; width: 50px; height: 50px; }
        
        .btn-play {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--color-pink), var(--color-stocking));
            border-radius: 50%;
            color: white;
            font-size: 1.8rem;
            box-shadow: 0 8px 20px rgba(255, 135, 171, 0.4);
        }
        
        .btn:hover { transform: scale(1.1); color: var(--color-pink); }
        .btn-play:hover { transform: scale(1.05) translateY(-2px); color: white; }
        .btn:active { transform: scale(0.95); }

        /* æ¨¡å¼æ¿€æ´»é¢œè‰² */
        .mode-loop { color: var(--color-pink) !important; text-shadow: 0 0 8px rgba(255,135,171,0.5); }
        .mode-random { color: var(--color-stocking) !important; text-shadow: 0 0 8px rgba(195,157,255,0.5); }

        /* æ­Œå•åˆ—è¡¨ */
        .playlist-box {
            width: 100%;
            max-height: 0;
            overflow-y: auto;
            background: rgba(255,255,255,0.4);
            border-radius: 15px;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .playlist-box.show {
            max-height: 180px; /* å±•å¼€é«˜åº¦ */
            margin-top: 10px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .playlist-item {
            padding: 12px 15px;
            font-size: 0.9rem;
            color: #444;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        .playlist-item:last-child { border-bottom: none; }
        .playlist-item:hover { background: rgba(255,255,255,0.6); }
        
        .playlist-item.active {
            color: var(--color-pink);
            font-weight: 700;
            background: rgba(255, 135, 171, 0.1);
        }
        .playlist-item.active::before {
            content: 'â™ª';
            margin-right: 8px;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .playlist-box::-webkit-scrollbar { width: 4px; }
        .playlist-box::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 2px; }

    </style>
</head>
<body>

    <!-- æ’­æ”¾å™¨ä¸»å¡ç‰‡ -->
    <div class="player-card">
        <!-- å”±ç‰‡å°é¢ -->
        <div class="disc-wrapper">
            <div class="music-disc" id="disc"></div>
        </div>

        <!-- ä¿¡æ¯åŒº -->
        <div class="song-info">
            <div class="song-title" id="songTitle">Loading...</div>
            <div class="song-status" id="songStatus">P&S Radio Station</div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-area">
            <span id="currTime">0:00</span>
            <input type="range" class="progress-bar" id="progressBar" value="0" min="0" max="100">
            <span id="totalTime">0:00</span>
        </div>

        <!-- æ§åˆ¶åŒº -->
        <div class="controls">
            <button class="btn btn-mode" id="modeBtn" title="æ’­æ”¾æ¨¡å¼">ğŸ”</button>
            <button class="btn btn-prev" id="prevBtn" title="ä¸Šä¸€é¦–">â®</button>
            <button class="btn btn-play" id="playBtn" title="æ’­æ”¾/æš‚åœ">â–¶</button>
            <button class="btn btn-next" id="nextBtn" title="ä¸‹ä¸€é¦–">â­</button>
            <button class="btn btn-mode" id="listBtn" title="æ­Œå•">ğŸ“œ</button>
        </div>

        <!-- æ­Œå•åˆ—è¡¨ -->
        <div class="playlist-box" id="playlistBox">
            <!-- JS å¡«å……åˆ—è¡¨ -->
        </div>
    </div>

    <audio id="bgmAudio" preload="none"></audio>

    <script>
        class MusicPlayer {
            constructor() {
                // ğŸŸ¢ é…ç½®åŒºåŸŸï¼šGitHub åœ°å€
                this.baseUrl = "https://stockielchan.github.io/stocking-music/";
                this.jsonUrl = this.baseUrl + "music.json?t=" + new Date().getTime();
                // é»˜è®¤å°é¢å›¾
                this.defaultCover = this.baseUrl + "musicmenu.jpg?t=" + new Date().getTime();

                // DOM å…ƒç´ 
                this.audio = document.getElementById('bgmAudio');
                this.disc = document.getElementById('disc');
                this.titleEl = document.getElementById('songTitle');
                this.statusEl = document.getElementById('songStatus');
                this.progressBar = document.getElementById('progressBar');
                this.currTimeEl = document.getElementById('currTime');
                this.totalTimeEl = document.getElementById('totalTime');
                this.playlistBox = document.getElementById('playlistBox');

                this.playBtn = document.getElementById('playBtn');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.modeBtn = document.getElementById('modeBtn');
                this.listBtn = document.getElementById('listBtn');

                // çŠ¶æ€
                this.playlist = [];
                this.currentIndex = 0;
                this.isPlaying = false;
                this.isDragging = false;
                
                this.playMode = 0; // 0:é¡ºåº, 1:å•æ›², 2:éšæœº
                this.modes = [
                    { icon: 'ğŸ”', name: 'é¡ºåºæ’­æ”¾', class: '' },
                    { icon: 'ğŸ”‚', name: 'å•æ›²å¾ªç¯', class: 'mode-loop' },
                    { icon: 'ğŸ”€', name: 'éšæœºæ’­æ”¾', class: 'mode-random' }
                ];

                this.init();
            }

            async init() {
                this.bindEvents();
                await this.fetchMusic();
                // åˆå§‹åŒ–é»˜è®¤å°é¢
                this.updateCover(null);
            }

            /* 1. è·å– GitHub æ­Œå• */
            async fetchMusic() {
                try {
                    const res = await fetch(this.jsonUrl);
                    if (!res.ok) throw new Error("Config Error");
                    const data = await res.json();

                    this.playlist = data.map(item => ({
                        title: item.title,
                        url: this.baseUrl + encodeURIComponent(item.file),
                        cover: item.cover ? this.baseUrl + encodeURIComponent(item.cover) : null
                    }));

                    if (this.playlist.length > 0) {
                        this.renderPlaylist();
                        this.loadSong(0, false);
                        this.titleEl.textContent = this.playlist[0].title;
                    } else {
                        this.titleEl.textContent = "æ­Œå•ä¸ºç©º";
                    }
                } catch (e) {
                    console.error(e);
                    this.titleEl.textContent = "åŠ è½½å¤±è´¥";
                    this.statusEl.textContent = "æ— æ³•è¿æ¥ GitHub";
                }
            }

            /* 2. æ¸²æŸ“æ­Œå• */
            renderPlaylist() {
                this.playlistBox.innerHTML = '';
                this.playlist.forEach((song, i) => {
                    const div = document.createElement('div');
                    div.className = 'playlist-item';
                    div.textContent = `${i + 1}. ${song.title}`;
                    div.onclick = () => this.loadSong(i, true);
                    this.playlistBox.appendChild(div);
                });
            }

            /* 3. åŠ è½½æ­Œæ›² */
            loadSong(index, autoPlay = true) {
                if (!this.playlist[index]) return;
                this.currentIndex = index;
                const song = this.playlist[index];

                this.audio.src = song.url;
                this.titleEl.textContent = song.title;
                this.statusEl.textContent = song.artist || "P&S OST"; // å¦‚æœJSONé‡Œæ²¡æœ‰artistå°±ç”¨é»˜è®¤
                
                this.updateCover(song.cover);
                this.highlightPlaylist(index);

                // é‡ç½®è¿›åº¦
                this.progressBar.value = 0;
                this.updateProgressBg(0);
                this.currTimeEl.textContent = "0:00";

                if (autoPlay) {
                    this.play();
                }
            }

            updateCover(url) {
                const imgUrl = url || this.defaultCover;
                this.disc.style.backgroundImage = `url('${imgUrl}')`;
            }

            highlightPlaylist(index) {
                const items = this.playlistBox.querySelectorAll('.playlist-item');
                items.forEach(el => el.classList.remove('active'));
                if (items[index]) {
                    items[index].classList.add('active');
                    items[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            /* 4. æ’­æ”¾æ§åˆ¶ */
            play() {
                this.audio.play().then(() => {
                    this.isPlaying = true;
                    this.updatePlayBtn();
                    this.disc.classList.remove('paused');
                    this.disc.classList.add('rotate');
                }).catch(() => {});
            }

            pause() {
                this.audio.pause();
                this.isPlaying = false;
                this.updatePlayBtn();
                this.disc.classList.add('paused');
            }

            togglePlay() {
                this.isPlaying ? this.pause() : this.play();
            }

            updatePlayBtn() {
                this.playBtn.textContent = this.isPlaying ? 'â¸' : 'â–¶';
            }

            /* 5. åˆ‡æ­Œé€»è¾‘ */
            next(isAuto = false) {
                if (isAuto && this.playMode === 1) { // å•æ›²å¾ªç¯
                    this.audio.currentTime = 0;
                    this.play();
                    return;
                }
                
                let nextIdx;
                if (this.playMode === 2) { // éšæœº
                    do {
                        nextIdx = Math.floor(Math.random() * this.playlist.length);
                    } while (this.playlist.length > 1 && nextIdx === this.currentIndex);
                } else { // é¡ºåº
                    nextIdx = (this.currentIndex + 1) % this.playlist.length;
                }
                this.loadSong(nextIdx, true);
            }

            prev() {
                let prevIdx = (this.currentIndex - 1 + this.playlist.length) % this.playlist.length;
                this.loadSong(prevIdx, true);
            }

            toggleMode() {
                this.playMode = (this.playMode + 1) % 3;
                const mode = this.modes[this.playMode];
                this.modeBtn.textContent = mode.icon;
                
                // æ ·å¼åˆ‡æ¢
                this.modeBtn.className = 'btn btn-mode ' + mode.class;
                
                // ä¸´æ—¶æ˜¾ç¤ºæç¤º
                const oldStatus = this.statusEl.textContent;
                this.statusEl.textContent = `æ¨¡å¼: ${mode.name}`;
                setTimeout(() => {
                    if(this.statusEl.textContent.includes('æ¨¡å¼')) 
                        this.statusEl.textContent = oldStatus;
                }, 1500);
            }

            toggleList() {
                this.playlistBox.classList.toggle('show');
            }

            /* 6. è¿›åº¦æ¡é€»è¾‘ */
            formatTime(s) {
                if (isNaN(s)) return "0:00";
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m}:${sec < 10 ? '0' + sec : sec}`;
            }

            updateProgressBg(percent) {
                this.progressBar.style.background = `linear-gradient(to right, var(--color-pink) ${percent}%, rgba(0,0,0,0.05) ${percent}%)`;
            }

            /* 7. äº‹ä»¶ç»‘å®š */
            bindEvents() {
                this.playBtn.onclick = () => this.togglePlay();
                this.nextBtn.onclick = () => this.next();
                this.prevBtn.onclick = () => this.prev();
                this.modeBtn.onclick = () => this.toggleMode();
                this.listBtn.onclick = () => this.toggleList();

                // è‡ªåŠ¨ä¸‹ä¸€é¦–
                this.audio.onended = () => this.next(true);
                
                // å…ƒæ•°æ®åŠ è½½
                this.audio.onloadedmetadata = () => {
                    this.totalTimeEl.textContent = this.formatTime(this.audio.duration);
                };

                // è¿›åº¦æ›´æ–°
                this.audio.ontimeupdate = () => {
                    if (this.isDragging) return;
                    const curr = this.audio.currentTime;
                    const total = this.audio.duration;
                    if (total) {
                        const percent = (curr / total) * 100;
                        this.progressBar.value = percent;
                        this.updateProgressBg(percent);
                        this.currTimeEl.textContent = this.formatTime(curr);
                    }
                };

                // æ‹–åŠ¨è¿›åº¦æ¡
                this.progressBar.oninput = (e) => {
                    this.isDragging = true;
                    const percent = e.target.value;
                    this.updateProgressBg(percent);
                    this.currTimeEl.textContent = this.formatTime((percent / 100) * this.audio.duration);
                };

                this.progressBar.onchange = (e) => {
                    this.isDragging = false;
                    this.audio.currentTime = (e.target.value / 100) * this.audio.duration;
                    if (!this.isPlaying) this.play();
                };
            }
        }

        new MusicPlayer();
    </script>
</body>
</html>