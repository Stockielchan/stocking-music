<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P&S Music Player</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== å…¨å±€æ ·å¼ ==================== */
        :root {
            --color-pink: #ff87ab;
            --color-stocking: #c39dff;
            --bg-glass: rgba(255, 255, 255, 0.85);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(160deg, #ffea7f 0%, #ff87ab 45%, #c39dff 100%);
            min-height: 100vh;
            /* å±…ä¸­å¸ƒå±€ */
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; /* ç¦æ­¢é¡µé¢æ»šåŠ¨ï¼Œåªå…è®¸å¡ç‰‡å†…æ“ä½œ */
        }

        /* ğŸŒˆ èƒŒæ™¯åŒ…è£¹å±‚ (é˜²æ­¢èƒŒæ™¯ä¸¢å¤±) */
        .app-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(160deg, #ffea7f 0%, #ff87ab 45%, #c39dff 100%);
            display: flex; justify-content: center; align-items: center;
        }

        /* æ’­æ”¾å™¨å¡ç‰‡ (è‡ªé€‚åº”é«˜åº¦) */
        .player-card {
            width: 90%; 
            max-width: 360px; /* ç¨å¾®è°ƒçª„ä¸€ç‚¹ï¼Œæ›´ç²¾è‡´ */
            /* ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ï¼šé«˜åº¦ä¸å†å†™æ­» 600pxï¼Œè€Œæ˜¯è‡ªé€‚åº” */
            height: auto;
            max-height: 95vh; /* ä¿è¯ä¸è¶…è¿‡å±å¹•é«˜åº¦ */
            aspect-ratio: 9/16; /* ä¿æŒå¤§æ¦‚çš„æ¯”ä¾‹ */
            
            background: var(--bg-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 30px; padding: 20px; /* å‡å°å†…è¾¹è· */
            box-shadow: var(--shadow);
            
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: all 0.3s ease;
            z-index: 10;
        }

        /* é¡¶éƒ¨æ˜¾ç¤ºåŒº */
        .visual-area {
            width: 100%; flex: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 10px; min-height: 180px; /* ä¿è¯å”±ç‰‡åŒºåŸŸæœ€å°é«˜åº¦ */
        }

        #visualizer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; opacity: 0.6; pointer-events: none;
        }

        .interaction-hint {
            position: absolute; bottom: 0; left: 0; width: 100%;
            text-align: center; font-size: 0.7rem; color: #888;
            pointer-events: none; opacity: 0.8; z-index: 5;
            transition: opacity 0.3s;
        }

        /* å”±ç‰‡æ¨¡å¼ (ç¨å¾®ç¼©å°ä¸€ç‚¹é€‚é…å°å±) */
        .disc-wrapper {
            width: 180px; height: 180px; /* ç¼©å°å°ºå¯¸ */
            border-radius: 50%; border: 5px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            position: absolute; transition: opacity 0.4s, transform 0.4s;
            background: linear-gradient(135deg, #ffea7f, #ff87ab);
            cursor: pointer; bottom: 20px; z-index: 2; overflow: hidden;
        }
        .music-disc {
            width: 100%; height: 100%; border-radius: 50%;
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }
        .music-disc::before, .music-disc::after { display: none !important; }

        .rotate { animation: spin 10s linear infinite; }
        .paused { animation-play-state: paused; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* æ­Œè¯æ¨¡å¼ */
        .lyric-wrapper {
            width: 100%; height: 100%;
            position: absolute; z-index: 3;
            opacity: 0; pointer-events: none; transform: scale(0.9);
            transition: opacity 0.4s, transform 0.4s;
            text-align: center;
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            cursor: pointer;
        }
        .lyric-list { list-style: none; padding: 100px 0; margin: 0; transition: transform 0.3s ease-out; }
        .lyric-line {
            color: #555; font-size: 0.9rem; line-height: 1.6;
            padding: 6px 10px; transition: all 0.3s; min-height: 24px; font-weight: 500;
        }
        .lyric-line.active {
            color: var(--color-pink); font-size: 1.1rem; font-weight: 800;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.9); transform: scale(1.05);
        }
        .lyric-line.pure-music { color: var(--color-stocking); font-weight: bold; font-size: 1rem; margin-top: 50px; opacity: 0.8; }
        .lyric-line span { display: block; font-size: 0.85em; color: #777; font-weight: normal; margin-top: 2px; }
        .lyric-line.active span { color: var(--color-stocking); font-weight: 600; }

        .show-lyrics .disc-wrapper { opacity: 0; pointer-events: none; transform: scale(0.8); }
        .show-lyrics .lyric-wrapper { opacity: 1; pointer-events: auto; transform: scale(1); }

        /* ä¿¡æ¯ */
        .song-info { text-align: center; width: 100%; margin-bottom: 10px; z-index: 2; }
        .song-title { font-size: 1.3rem; font-weight: 700; color: #333; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-status { font-size: 0.8rem; color: #666; font-weight: 500; }

        /* è¿›åº¦æ¡ */
        .progress-area {
            width: 100%; display: flex; align-items: center; gap: 10px;
            font-size: 0.7rem; color: #555; font-weight: 600; margin-bottom: 15px; z-index: 2;
        }
        .progress-bar {
            flex: 1; -webkit-appearance: none; height: 5px;
            background: rgba(0,0,0,0.1); border-radius: 3px; outline: none; cursor: pointer;
        }
        .progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%;
            background: var(--color-pink); box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.1s;
        }

        /* æŒ‰é’® */
        .controls { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 5px; margin-bottom: 5px; z-index: 2; }
        .btn { background: none; border: none; cursor: pointer; color: #555; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-mode { width: 40px; height: 40px; }
        .btn-prev, .btn-next { width: 45px; height: 45px; }
        .btn-play {
            width: 60px; height: 60px; background: linear-gradient(135deg, var(--color-pink), var(--color-stocking));
            border-radius: 50%; color: white; box-shadow: 0 8px 20px rgba(255, 135, 171, 0.4);
        }
        .btn:hover { transform: scale(1.1); color: var(--color-pink); }
        .btn-play:hover { transform: scale(1.05) translateY(-2px); color: white; }
        
        .mode-loop { color: var(--color-pink) !important; }
        .mode-random { color: var(--color-stocking) !important; }

        .btn svg { width: 24px; height: 24px; fill: currentColor; }
        .btn-play svg { width: 32px; height: 32px; fill: white; }

        /* æ­Œå•åˆ—è¡¨ */
        .playlist-box {
            position: absolute; bottom: 0; left: 0; width: 100%; max-height: 0;
            background: rgba(255,255,255,0.95); border-radius: 25px;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; z-index: 10;
        }
        .playlist-box.show { max-height: 60%; border-top: 1px solid rgba(0,0,0,0.1); box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .playlist-item { padding: 12px 20px; font-size: 0.9rem; color: #444; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
        .playlist-item:hover { background: rgba(255, 135, 171, 0.1); }
        .playlist-item.active { color: var(--color-pink); font-weight: 700; }
        .playlist-item.active::before { content: 'â™ª '; }
    </style>
</head>
<body>

    <div class="app-wrapper">
        <div class="player-card" id="playerCard">
            <div class="visual-area">
                <canvas id="visualizer"></canvas>
                <div class="disc-wrapper" id="discWrapper">
                    <div class="music-disc" id="disc"></div>
                </div>
                <div class="lyric-wrapper" id="lyricWrapper">
                    <ul class="lyric-list" id="lyricList">
                        <li class="lyric-line">P&S Radio Station</li>
                    </ul>
                </div>
                <div class="interaction-hint" id="interactionHint">ç‚¹å‡»å°é¢æ˜¾ç¤ºæ­Œè¯</div>
            </div>

            <div class="song-info">
                <div class="song-title" id="songTitle">Loading...</div>
                <div class="song-status" id="songStatus">P&S Radio</div>
            </div>

            <div class="progress-area">
                <span id="currTime">0:00</span>
                <input type="range" class="progress-bar" id="progressBar" value="0" min="0" max="100">
                <span id="totalTime">0:00</span>
            </div>

            <div class="controls">
                <button class="btn btn-mode" id="modeBtn" title="åˆ‡æ¢æ¨¡å¼"></button>
                <button class="btn btn-prev" id="prevBtn">
                    <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </button>
                <button class="btn btn-play" id="playBtn">
                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="btn btn-next" id="nextBtn">
                    <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>
                <button class="btn btn-mode" id="listBtn" title="æ­Œå•">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                </button>
            </div>

            <div class="playlist-box" id="playlistBox"></div>
        </div>
    </div>

    <audio id="bgmAudio" preload="none" crossorigin="anonymous"></audio>

    <script>
        class MusicPlayer {
            constructor() {
                this.baseUrl = "https://stockielchan.github.io/stocking-music/";
                this.jsonUrl = this.baseUrl + "music.json?t=" + new Date().getTime();
                this.defaultCover = this.baseUrl + "musicmenu.jpg";

                this.audio = document.getElementById('bgmAudio');
                this.disc = document.getElementById('disc');
                this.titleEl = document.getElementById('songTitle');
                this.statusEl = document.getElementById('songStatus');
                this.progressBar = document.getElementById('progressBar');
                this.currTimeEl = document.getElementById('currTime');
                this.totalTimeEl = document.getElementById('totalTime');
                this.playlistBox = document.getElementById('playlistBox');
                this.lyricList = document.getElementById('lyricList');
                this.playerCard = document.getElementById('playerCard');
                this.interactionHint = document.getElementById('interactionHint');
                this.canvas = document.getElementById('visualizer');

                this.playBtn = document.getElementById('playBtn');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.modeBtn = document.getElementById('modeBtn');
                this.listBtn = document.getElementById('listBtn');

                this.playlist = [];
                this.currentIndex = 0;
                this.isPlaying = false;
                this.isDragging = false;
                this.lyrics = [];
                this.hasLyrics = false;

                this.playMode = 0; 
                this.icons = {
                    play: '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>',
                    pause: '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>',
                    seq: '<svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v6z"/></svg>',
                    loop: '<svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v6z"/><text x="12" y="15" font-size="8" text-anchor="middle" fill="currentColor" font-weight="bold">1</text></svg>',
                    random: '<svg viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>'
                };
                this.modes = [
                    { icon: this.icons.seq, name: 'é¡ºåº', class: '' },
                    { icon: this.icons.loop, name: 'å•æ›²', class: 'mode-loop' },
                    { icon: this.icons.random, name: 'éšæœº', class: 'mode-random' }
                ];
                
                this.audioCtx = null;
                this.analyser = null;
                this.dataArray = null;
                this.canvasCtx = this.canvas.getContext('2d');
                this.isVisualizerInited = false;

                this.init();
            }

            async init() {
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                this.bindEvents();
                this.updateModeIcon();
                await this.fetchMusic();
                this.updateCover(null);
            }

            // ... (å¯è§†åŒ–å’Œæ­Œè¯é€»è¾‘ä¿æŒä¸å˜ï¼Œä¸ºäº†ç®€æ´çœç•¥éƒ¨åˆ†ï¼Œé€»è¾‘åŒä¸Š) ...
            // ä¸‹é¢æ˜¯ä¿®å¤çš„æ ¸å¿ƒé€»è¾‘

            initVisualizer() {
                if (this.isVisualizerInited) return;
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioCtx = new AudioContext();
                    const source = this.audioCtx.createMediaElementSource(this.audio);
                    this.analyser = this.audioCtx.createAnalyser();
                    source.connect(this.analyser);
                    this.analyser.connect(this.audioCtx.destination);
                    this.analyser.fftSize = 64;
                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    this.isVisualizerInited = true;
                    this.drawVisualizer();
                } catch(e) { console.log("Visualizer init failed"); }
            }

            drawVisualizer() {
                if (!this.isPlaying) return;
                requestAnimationFrame(() => this.drawVisualizer());
                this.analyser.getByteFrequencyData(this.dataArray);
                const width = this.canvas.width;
                const height = this.canvas.height;
                const barWidth = (width / this.dataArray.length) * 0.8;
                const gap = (width / this.dataArray.length) * 0.2;
                this.canvasCtx.clearRect(0, 0, width, height);
                let x = 0;
                for(let i = 0; i < this.dataArray.length; i++) {
                    const value = this.dataArray[i];
                    const barHeight = (value / 255) * (height * 0.6);
                    const r = 255;
                    const g = 135 + (255 - value) / 2;
                    const b = 171 + (255 - value) / 2;
                    this.canvasCtx.fillStyle = `rgba(${r},${g},${b}, 0.6)`;
                    this.canvasCtx.fillRect(x, height - barHeight, barWidth, barHeight);
                    x += barWidth + gap;
                }
            }
            resizeCanvas() {
                this.canvas.width = this.canvas.clientWidth;
                this.canvas.height = this.canvas.clientHeight;
            }

            async fetchMusic() {
                try {
                    const res = await fetch(this.jsonUrl);
                    if (!res.ok) throw new Error("Config Error");
                    const data = await res.json();
                    this.playlist = data.map(item => ({
                        title: item.title,
                        url: this.baseUrl + encodeURIComponent(item.file),
                        cover: item.cover ? this.baseUrl + encodeURIComponent(item.cover) : null,
                        lrc: item.lrc ? this.baseUrl + encodeURIComponent(item.lrc) : null
                    }));
                    if (this.playlist.length > 0) {
                        this.renderPlaylist();
                        this.loadSong(0, false);
                    } else {
                        this.titleEl.textContent = "æ­Œå•ä¸ºç©º";
                    }
                } catch (e) {
                    console.error(e);
                    this.titleEl.textContent = "åŠ è½½å¤±è´¥";
                }
            }

            renderPlaylist() {
                this.playlistBox.innerHTML = '';
                this.playlist.forEach((song, i) => {
                    const div = document.createElement('div');
                    div.className = 'playlist-item';
                    div.textContent = `${i + 1}. ${song.title}`;
                    div.onclick = (e) => {
                        e.stopPropagation(); // é˜²æ­¢å†’æ³¡è§¦å‘å…¨å±€å…³é—­
                        this.loadSong(i, true);
                        this.toggleList();
                    };
                    this.playlistBox.appendChild(div);
                });
            }

            loadSong(index, autoPlay = true) {
                if (!this.playlist[index]) return;
                this.currentIndex = index;
                const song = this.playlist[index];
                this.audio.src = song.url;
                this.titleEl.textContent = song.title;
                this.statusEl.textContent = "P&S Radio";
                this.updateCover(song.cover);
                this.highlightPlaylist(index);
                this.loadLyrics(song.lrc);
                this.progressBar.value = 0;
                this.updateProgressBg(0);
                this.currTimeEl.textContent = "0:00";
                if (autoPlay) this.play();
            }
            
            async loadLyrics(lrcUrl) {
                this.lyricList.innerHTML = '<li class="lyric-line">Loading...</li>';
                this.lyrics = [];
                this.hasLyrics = false;
                if (!lrcUrl) { this.showPureMusic(); return; }
                try {
                    const res = await fetch(lrcUrl);
                    if (res.ok) {
                        const text = await res.text();
                        this.parseLyrics(text);
                        this.renderLyrics();
                        this.hasLyrics = true;
                    } else { this.showPureMusic(); }
                } catch (e) { this.showPureMusic(); }
            }
            
            showPureMusic() {
                this.lyricList.innerHTML = '<li class="lyric-line pure-music">[çº¯éŸ³ä¹ï¼Œæš‚æ— æ­Œè¯]</li>';
                this.lyrics = [];
            }

            parseLyrics(text) {
                const lines = text.split('\n');
                const regex = /^\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)$/;
                this.lyrics = [];
                let currentLyric = null;
                lines.forEach(line => {
                    const str = line.trim();
                    if (!str) return;
                    const matches = str.match(regex);
                    if (matches) {
                        const time = parseInt(matches[1])*60 + parseInt(matches[2]) + parseInt(matches[3])/1000;
                        const content = matches[4].trim();
                        currentLyric = { time, content };
                        this.lyrics.push(currentLyric);
                    } else {
                        if (currentLyric) currentLyric.content += `<span>${str}</span>`;
                    }
                });
            }

            renderLyrics() {
                this.lyricList.innerHTML = '';
                this.lyricList.innerHTML += '<li class="lyric-line" style="height: 100px;"></li>';
                this.lyrics.forEach((line, i) => {
                    const li = document.createElement('li');
                    li.className = 'lyric-line';
                    li.innerHTML = line.content;
                    li.dataset.index = i;
                    this.lyricList.appendChild(li);
                });
                this.lyricList.innerHTML += '<li class="lyric-line" style="height: 120px;"></li>';
            }

            syncLyrics(currentTime) {
                if (!this.hasLyrics) return;
                let activeIndex = -1;
                for (let i = 0; i < this.lyrics.length; i++) {
                    if (currentTime >= this.lyrics[i].time) activeIndex = i;
                    else break;
                }
                if (activeIndex !== -1) {
                    const activeLine = this.lyricList.querySelectorAll('.lyric-line[data-index]')[activeIndex];
                    if (activeLine && !activeLine.classList.contains('active')) {
                        const oldActive = this.lyricList.querySelector('.active');
                        if (oldActive) oldActive.classList.remove('active');
                        activeLine.classList.add('active');
                        const containerHeight = document.getElementById('lyricWrapper').clientHeight;
                        const offset = activeLine.offsetTop - containerHeight / 2 + activeLine.clientHeight / 2;
                        this.lyricList.style.transform = `translateY(-${Math.max(0, offset)}px)`;
                    }
                }
            }

            updateCover(url) {
                const imgUrl = url || this.defaultCover;
                this.disc.style.backgroundImage = `url('${imgUrl}')`;
            }

            highlightPlaylist(index) {
                const items = this.playlistBox.querySelectorAll('.playlist-item');
                items.forEach(el => el.classList.remove('active'));
                if (items[index]) {
                    items[index].classList.add('active');
                    if (this.playlistBox.classList.contains('show')) {
                        const container = this.playlistBox;
                        const element = items[index];
                        const targetTop = element.offsetTop - container.clientHeight / 2 + element.clientHeight / 2;
                        container.scrollTo({ top: targetTop, behavior: 'smooth' });
                    }
                }
            }

            play() {
                if (!this.isVisualizerInited) this.initVisualizer();
                if (this.audioCtx && this.audioCtx.state === 'suspended') this.audioCtx.resume();
                this.audio.play().then(() => {
                    this.isPlaying = true;
                    this.updatePlayBtn();
                    this.disc.classList.remove('paused');
                    this.disc.classList.add('rotate');
                    this.drawVisualizer();
                }).catch(() => {});
            }

            pause() {
                this.audio.pause();
                this.isPlaying = false;
                this.updatePlayBtn();
                this.disc.classList.add('paused');
            }

            togglePlay() { this.isPlaying ? this.pause() : this.play(); }
            updatePlayBtn() { this.playBtn.innerHTML = this.isPlaying ? this.icons.pause : this.icons.play; }

            next(isAuto = false) {
                if (isAuto && this.playMode === 1) {
                    this.audio.currentTime = 0; this.play(); return;
                }
                let nextIdx;
                if (this.playMode === 2) {
                    do { nextIdx = Math.floor(Math.random() * this.playlist.length); }
                    while (this.playlist.length > 1 && nextIdx === this.currentIndex);
                } else {
                    nextIdx = (this.currentIndex + 1) % this.playlist.length;
                }
                this.loadSong(nextIdx, true);
            }

            prev() {
                let prevIdx = (this.currentIndex - 1 + this.playlist.length) % this.playlist.length;
                this.loadSong(prevIdx, true);
            }

            toggleMode() {
                this.playMode = (this.playMode + 1) % 3;
                this.updateModeIcon();
            }
            
            updateModeIcon() {
                const mode = this.modes[this.playMode];
                this.modeBtn.innerHTML = mode.icon;
                this.modeBtn.className = 'btn btn-mode ' + mode.class;
                const oldStatus = this.statusEl.textContent;
                this.statusEl.textContent = `Mode: ${mode.name}`;
                setTimeout(() => { if(this.statusEl.textContent.includes('Mode')) this.statusEl.textContent = oldStatus; }, 1500);
            }

            toggleList() { 
                this.playlistBox.classList.toggle('show');
                if (this.playlistBox.classList.contains('show')) {
                    this.highlightPlaylist(this.currentIndex);
                }
            }
            
            toggleVisual() {
                this.playerCard.classList.toggle('show-lyrics');
                if (this.playerCard.classList.contains('show-lyrics')) {
                    this.interactionHint.textContent = "ç‚¹å‡»è¿”å›å°é¢";
                } else {
                    this.interactionHint.textContent = "ç‚¹å‡»å°é¢æ˜¾ç¤ºæ­Œè¯";
                }
            }

            formatTime(s) {
                if (isNaN(s)) return "0:00";
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m}:${sec < 10 ? '0' + sec : sec}`;
            }

            updateProgressBg(percent) {
                this.progressBar.style.background = `linear-gradient(to right, var(--color-pink) ${percent}%, rgba(0,0,0,0.05) ${percent}%)`;
            }

            bindEvents() {
                this.playBtn.onclick = () => this.togglePlay();
                this.nextBtn.onclick = () => this.next();
                this.prevBtn.onclick = () => this.prev();
                this.modeBtn.onclick = () => this.toggleMode();
                this.listBtn.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢å†’æ³¡
                    this.toggleList();
                };
                
                document.getElementById('discWrapper').onclick = () => this.toggleVisual();
                document.getElementById('lyricWrapper').onclick = () => this.toggleVisual();

                this.audio.onended = () => this.next(true);
                this.audio.onloadedmetadata = () => {
                    this.totalTimeEl.textContent = this.formatTime(this.audio.duration);
                };

                this.audio.ontimeupdate = () => {
                    if (this.isDragging) return;
                    const curr = this.audio.currentTime;
                    const total = this.audio.duration;
                    this.syncLyrics(curr);
                    if (total) {
                        const percent = (curr / total) * 100;
                        this.progressBar.value = percent;
                        this.updateProgressBg(percent);
                        this.currTimeEl.textContent = this.formatTime(curr);
                    }
                };

                this.progressBar.oninput = (e) => {
                    this.isDragging = true;
                    const percent = e.target.value;
                    this.updateProgressBg(percent);
                    this.currTimeEl.textContent = this.formatTime((percent / 100) * this.audio.duration);
                };

                this.progressBar.onchange = (e) => {
                    this.isDragging = false;
                    this.audio.currentTime = (e.target.value / 100) * this.audio.duration;
                    if (!this.isPlaying) this.play();
                };

                // ğŸ‘‡ ä¿®å¤ï¼šå…¨å±€ç‚¹å‡»å…³é—­æ­Œå•
                document.addEventListener('click', (e) => {
                    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æ­Œå•æœ¬èº« ä¸” ä¸æ˜¯æ­Œå•æŒ‰é’®
                    if (this.playlistBox.classList.contains('show') && 
                        !this.playlistBox.contains(e.target) && 
                        !this.listBtn.contains(e.target)) {
                        this.toggleList();
                    }
                });
            }
        }

        new MusicPlayer();
    </script>
</body>
</html>